<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modifier l'utilisateur - LuxBags</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .bg-gradient {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d1a1a 100%);
        }
        
        .input-focus:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        }
        
        .file-input-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
            border: 2px dashed #4b5563;
            border-radius: 0.375rem;
            background-color: #374151;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .file-input-label:hover {
            border-color: #818cf8;
            background-color: #4b5563;
        }
        
        .file-input-label i {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            color: #818cf8;
        }
        
        .file-name {
            margin-top: 0.5rem;
            font-size: 0.875rem;
            color: #9ca3af;
        }
        
        .profile-image-preview {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #6366f1;
        }
    </style>
</head>

<body class="bg-gray-900 min-h-screen">

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <div class="max-w-md mx-auto bg-gray-800 rounded-xl shadow-lg overflow-hidden">
            <div class="p-8">
                <h2 class="text-2xl font-bold text-white mb-6 text-center">Modifier l'utilisateur</h2>

                <form id="editUserForm" class="space-y-6">
                    <!-- Photo de profil -->
                    <div class="flex flex-col items-center space-y-4">
                        <div class="relative">
                            <img id="profileImagePreview" src="" alt="Photo de profil" class="profile-image-preview">
                            <input type="file" id="profile_image" name="profile_image" accept="image/*" class="hidden">
                            <label for="profile_image" class="absolute bottom-0 right-0 bg-indigo-600 text-white p-2 rounded-full cursor-pointer hover:bg-indigo-700 transition duration-300">
                                <i class="fas fa-camera"></i>
                            </label>
                        </div>
                        <div>
                            <label for="profile_image" class="file-input-label">
                                <i class="fas fa-image"></i>
                                <span class="text-gray-300">Cliquez pour changer la photo</span>
                                <span id="profile-image-name" class="file-name">Aucun fichier sélectionné</span>
                            </label>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="first_name" class="block text-sm font-medium text-gray-400 mb-2">Prénom</label>
                            <input type="text" id="first_name" name="first_name" required class="w-full px-4 py-3 rounded-lg bg-gray-700 border border-gray-600 text-white focus:border-indigo-500 focus:outline-none input-focus">
                        </div>
                        <div>
                            <label for="last_name" class="block text-sm font-medium text-gray-400 mb-2">Nom</label>
                            <input type="text" id="last_name" name="last_name" required class="w-full px-4 py-3 rounded-lg bg-gray-700 border border-gray-600 text-white focus:border-indigo-500 focus:outline-none input-focus">
                        </div>
                    </div>

                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-400 mb-2">Email</label>
                        <input type="email" id="email" name="email" required class="w-full px-4 py-3 rounded-lg bg-gray-700 border border-gray-600 text-white focus:border-indigo-500 focus:outline-none input-focus">
                    </div>

                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-400 mb-2">Mot de passe (laisser vide pour ne pas modifier)</label>
                        <input type="password" id="password" name="password" class="w-full px-4 py-3 rounded-lg bg-gray-700 border border-gray-600 text-white focus:border-indigo-500 focus:outline-none input-focus">
                    </div>

                    <div>
                        <label for="phone" class="block text-sm font-medium text-gray-400 mb-2">Téléphone</label>
                        <input type="tel" id="phone" name="phone" class="w-full px-4 py-3 rounded-lg bg-gray-700 border border-gray-600 text-white focus:border-indigo-500 focus:outline-none input-focus">
                    </div>

                    <div>
                        <label for="address" class="block text-sm font-medium text-gray-400 mb-2">Adresse</label>
                        <input type="text" id="address" name="address" class="w-full px-4 py-3 rounded-lg bg-gray-700 border border-gray-600 text-white focus:border-indigo-500 focus:outline-none input-focus">
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="city" class="block text-sm font-medium text-gray-400 mb-2">Ville</label>
                            <input type="text" id="city" name="city" class="w-full px-4 py-3 rounded-lg bg-gray-700 border border-gray-600 text-white focus:border-indigo-500 focus:outline-none input-focus">
                        </div>
                        <div>
                            <label for="country" class="block text-sm font-medium text-gray-400 mb-2">Pays</label>
                            <input type="text" id="country" name="country" class="w-full px-4 py-3 rounded-lg bg-gray-700 border border-gray-600 text-white focus:border-indigo-500 focus:outline-none input-focus">
                        </div>
                    </div>

                    <div class="flex space-x-4">
                        <button type="submit" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg font-medium transition duration-300 transform hover:scale-105">
                            Mettre à jour
                        </button>
                        <a href="/public/profile.html" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-lg font-medium text-center transition duration-300 transform hover:scale-105">
                            Annuler
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <script>
        // Récupération de l'ID de l'utilisateur depuis l'URL
        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get('id');

        // Fonction pour charger les données de l'utilisateur
        async function loadUserData() {
            try {
                const response = await fetch(`/users/${userId}`);
                if (!response.ok) {
                    throw new Error('Erreur lors de la récupération des données utilisateur');
                }
                const user = await response.json();

                // Remplissage du formulaire avec les données de l'utilisateur
                document.getElementById('first_name').value = user.first_name || '';
                document.getElementById('last_name').value = user.last_name || '';
                document.getElementById('email').value = user.email || '';
                document.getElementById('phone').value = user.phone || '';
                document.getElementById('address').value = user.address || '';
                document.getElementById('city').value = user.city || '';
                document.getElementById('country').value = user.country || '';

                // Afficher la photo de profil si elle existe
                updateProfileImage(user.profile_image);
            } catch (error) {
                console.error('Erreur lors du chargement des données:', error);
                alert(error.message || 'Une erreur est survenue lors du chargement des données de l\'utilisateur.');
            }
        }

        // Fonction pour mettre à jour l'affichage de la photo de profil
        function updateProfileImage(imagePath) {
            const profileImagePreview = document.getElementById('profileImagePreview');
            if (imagePath) {
                profileImagePreview.src = `/uploads/users/${imagePath}`;
            } else {
                profileImagePreview.src = 'https://via.placeholder.com/150?text=No+Photo';
            }
        }

        // Gestion de la soumission du formulaire
        document.getElementById('editUserForm').addEventListener('submit', async(e) => {
            e.preventDefault();

            try {
                const formData = new FormData();

                // Ajout des champs texte
                formData.append('first_name', document.getElementById('first_name').value);
                formData.append('last_name', document.getElementById('last_name').value);
                formData.append('email', document.getElementById('email').value);
                formData.append('phone', document.getElementById('phone').value);
                formData.append('address', document.getElementById('address').value);
                formData.append('city', document.getElementById('city').value);
                formData.append('country', document.getElementById('country').value);

                // Ajout du mot de passe seulement s'il a été modifié
                const password = document.getElementById('password').value;
                if (password) {
                    formData.append('password', password);
                }

                // Ajout de la photo de profil si elle a été modifiée
                const profileImage = document.getElementById('profile_image').files[0];
                if (profileImage) {
                    // Vérification de la taille du fichier (max 5MB)
                    if (profileImage.size > 5 * 1024 * 1024) {
                        throw new Error('La taille du fichier ne doit pas dépasser 5MB');
                    }

                    // Vérification du type de fichier
                    if (!profileImage.type.startsWith('image/')) {
                        throw new Error('Format de fichier non supporté. Utilisez une image (JPG, PNG, GIF).');
                    }

                    formData.append('profile_image', profileImage);
                }

                const response = await fetch(`/users/${userId}`, {
                    method: 'PUT',
                    body: formData
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Erreur lors de la mise à jour de l\'utilisateur');
                }

                const data = await response.json();
                if (data.success) {
                    // Mise à jour de l'image de profil si elle a été modifiée
                    if (data.profile_image) {
                        updateProfileImage(data.profile_image);
                    }

                    alert('Utilisateur mis à jour avec succès.');
                    window.location.href = '/public/profile.html';
                } else {
                    throw new Error(data.error || 'Erreur lors de la mise à jour de l\'utilisateur');
                }
            } catch (error) {
                console.error('Erreur:', error);
                alert(error.message || 'Une erreur est survenue lors de la mise à jour.');
            }
        });

        // Gestion de l'affichage de la prévisualisation de l'image
        document.getElementById('profile_image').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                try {
                    // Vérification de la taille du fichier (max 5MB)
                    if (file.size > 5 * 1024 * 1024) {
                        throw new Error('La taille du fichier ne doit pas dépasser 5MB');
                    }

                    // Vérification du type de fichier
                    if (!file.type.startsWith('image/')) {
                        throw new Error('Format de fichier non supporté. Utilisez une image (JPG, PNG, GIF).');
                    }

                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('profileImagePreview').src = e.target.result;
                    }
                    reader.readAsDataURL(file);
                    document.getElementById('profile-image-name').textContent = file.name;
                } catch (error) {
                    alert(error.message);
                    this.value = '';
                    document.getElementById('profile-image-name').textContent = 'Aucun fichier sélectionné';
                }
            }
        });

        // Charger les données de l'utilisateur au chargement de la page
        document.addEventListener('DOMContentLoaded', loadUserData);
    </script>
</body>

</html>